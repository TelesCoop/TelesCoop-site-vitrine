---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ProjectCard from '../components/ProjectCard.astro';
import InlineSvg from '../components/InlineSvg.astro';
import { getCollection, getEntry } from 'astro:content';

const projectsCollection = await getCollection('projects', ({ data }) => !data.draft);
const categories = await getEntry('data', 'categories');

const projectsData = projectsCollection.map(p => ({ ...p.data, slug: p.slug, content: p.body }));
const categoriesData = categories?.data || {};

const title = 'Nos projets';
const description = 'Les projets que nous avons fièrement réalisés.';
const top = 'Nous nous adaptons aux besoins du client et le conseillons au mieux en respectant nos valeurs. Nos réalisations peuvent aller du petit projet utile et amovible à des structures plus complexes.';

const projectCategories = Object.entries(categoriesData)
  .filter(([_, cat]: [string, any]) => cat.type === 'project')
  .map(([key, cat]: [string, any]) => ({ key, ...cat }));

function slugify(text: string) {
  return text.toString().toLowerCase().trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
}

// Color mapping for SVG adaptation
const colorMapping = {
  '#FFCD4E': '--color-yellow',
  '#ffcd4e': '--color-yellow',
  '#FF5631': '--color-coral',
  '#ff5631': '--color-coral',
  '#60E093': '--color-green',
  '#60e093': '--color-green',
  '#A8CFEE': '--color-blue',
  '#a8cfee': '--color-blue',
  '#1E1C1C': '--color-border',
  '#1e1c1c': '--color-border',
  '#000000': '--color-border',
  '#000': '--color-border',
};
---

<Layout title={title} description={description}>
  <Header slot="header" />

  <div class="container mx-auto px-4 py-16 mt-16">
    <div class="text-center mb-12">
      <div class="md:hidden mx-auto mb-6" style="height: 120px">
        <InlineSvg
          src="/img/svg/illustration-projet.svg"
          alt=""
          colors={colorMapping}
          class="mx-auto h-full"
        />
      </div>
      <h1 class="uppercase text-4xl md:text-5xl mb-6">{title}</h1>
      <p class="text-center text-2xl text-black max-w-3xl mx-auto">
        {top}
      </p>
    </div>

    <!-- Search and Filters -->
    <div class="border-t border-b border-gray-200 py-6 my-8">
      <div class="flex flex-col md:flex-row gap-6">
        <div class="md:w-1/4">
          <h2 class="font-code text-xl font-semibold">Recherche & Filtres</h2>
        </div>
        <div class="md:w-3/4 space-y-4">
          <!-- Search -->
          <div>
            <label for="search-input" class="font-code text-sm mb-2 text-black block">Rechercher un projet</label>
            <input
              type="text"
              id="search-input"
              placeholder="Nom du projet, description..."
              class="w-full px-4 py-2 border-2 border-black rounded-[10px] focus:outline-none focus:ring-2 focus:ring-orange"
            />
          </div>

          <!-- Category filters -->
          <div>
            <h3 class="font-code text-sm mb-3 text-black">Types de projet</h3>
            <div class="flex flex-wrap gap-2 mb-4">
              {projectCategories.map((category: any) => (
                <button
                  class="filter-btn"
                  data-category={slugify(category.name)}
                  data-color={category.colorClass}
                >
                  {category.name}
                </button>
              ))}
            </div>
          </div>

          <button
            id="reset-filters"
            class="btn"
          >
            Réinitialiser
          </button>
        </div>
      </div>
    </div>

    <!-- Projects Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-12" id="projects-container">
      {projectsData.map((project: any, index: number) => (
        <ProjectCard project={project} categories={categoriesData} index={index} />
      ))}
    </div>

    <p class="text-center mt-12 text-black">
      Et bien d'autres projets...
    </p>
  </div>

  <Footer slot="footer" />
</Layout>

<script>
  let activeFilters = new Set<string>();
  let searchQuery = '';

  function updateProjects() {
    const cards = document.querySelectorAll('.project-card');

    cards.forEach((card) => {
      const cardElement = card as HTMLElement;
      const cardCategories = (card.getAttribute('data-categories') || '').split(' ').filter(Boolean);
      const cardTitle = (card.getAttribute('data-title') || '').toLowerCase();
      const cardDescription = (card.getAttribute('data-description') || '').toLowerCase();

      // Check category filter
      const matchesCategory = activeFilters.size === 0 || cardCategories.some(cat => activeFilters.has(cat));

      // Check search query
      const matchesSearch = searchQuery === '' ||
        cardTitle.includes(searchQuery.toLowerCase()) ||
        cardDescription.includes(searchQuery.toLowerCase());

      // Show only if matches both filters
      cardElement.style.display = matchesCategory && matchesSearch ? 'block' : 'none';
    });
  }

  // Category filters
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const category = target.getAttribute('data-category');

      if (category) {
        if (activeFilters.has(category)) {
          activeFilters.delete(category);
          target.classList.remove('active');
        } else {
          activeFilters.add(category);
          target.classList.add('active');
        }

        updateProjects();
      }
    });
  });

  // Search input
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  searchInput?.addEventListener('input', (e) => {
    searchQuery = (e.target as HTMLInputElement).value;
    updateProjects();
  });

  // Reset filters
  document.getElementById('reset-filters')?.addEventListener('click', () => {
    activeFilters.clear();
    searchQuery = '';
    searchInput.value = '';
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    updateProjects();
  });
</script>
