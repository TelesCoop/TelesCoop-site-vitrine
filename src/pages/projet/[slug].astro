---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const projects = await getCollection('projects', ({ data }) => !data.draft);

  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project }
  }));
}

const { project } = Astro.props;
const { data, body } = project;
const { Content } = await project.render();
const categories = await getEntry('data', 'categories');
const categoriesData = categories?.data || {};

function getCategoryColor(categoryName: string) {
  const category = categoriesData[categoryName];
  const colorMap: Record<string, string> = {
    'grey': 'bg-gray-600',
    'orange': 'bg-accent-orange',
    'yellow': 'bg-accent-yellow',
    'danger': 'bg-red-600',
    'info': 'bg-blue-600',
    'success': 'bg-green-600',
    'blue': 'bg-accent-blue',
  };
  return colorMap[category?.colorClass] || 'bg-gray-600';
}

function getCategoryTextColor(categoryName: string) {
  const category = categoriesData[categoryName];
  return category?.textWhite ? 'text-white' : 'text-black';
}
---

<Layout title={data.title} description={data.projectResume}>
  <Header slot="header" />

  <article class="container mx-auto px-4 py-16 mt-16 max-w-4xl">
    <!-- Header -->
    <header class="mb-12">
      <h1 class="text-4xl md:text-5xl font-light mb-6">{data.title}</h1>

      {data.categories && data.categories.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-6">
          {data.categories.map((cat: string) => (
            <span
              class={`px-3 py-1 rounded-full text-sm font-medium ${getCategoryColor(cat)} ${getCategoryTextColor(cat)}`}
            >
              {categoriesData[cat]?.name || cat}
            </span>
          ))}
        </div>
      )}

      {data.projectThumbnail && (
        <img
          src={data.projectThumbnail}
          alt={data.projectThumbnailAlt || data.title}
          class="w-full rounded-lg shadow-lg mb-8"
        />
      )}
    </header>

    <!-- Project Info -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
      <div class="md:col-span-2 space-y-6">
        <div>
          <h2 class="text-2xl font-semibold mb-4">Résumé</h2>
          <p class="text-lg text-gray-700">{data.projectResume}</p>
        </div>

        {body && (
          <div>
            <h2 class="text-2xl font-semibold mb-4">Description</h2>
            <div class="prose prose-lg max-w-none">
              <Content />
            </div>
          </div>
        )}

        {data.testimony && (
          <div class="bg-gray-50 p-6 rounded-lg border-l-4 border-accent-blue">
            <h3 class="font-semibold mb-2">Témoignage</h3>
            <p class="italic text-gray-700">"{data.testimony}"</p>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        {data.clientName && (
          <div>
            <h3 class="font-semibold mb-2">Client</h3>
            <p class="text-gray-700">{data.clientName}</p>
            {data.clientDescription && (
              <p class="text-sm text-gray-600 mt-2">{data.clientDescription}</p>
            )}
          </div>
        )}

        {data.projectStatus && (
          <div>
            <h3 class="font-semibold mb-2">Statut</h3>
            <p class="text-gray-700">{data.projectStatus}</p>
          </div>
        )}

        {data.projectDuration && (
          <div>
            <h3 class="font-semibold mb-2">Durée</h3>
            <p class="text-gray-700">
              {data.projectDuration} {data.projectDurationUnit || ''}
            </p>
          </div>
        )}

        {data.projectStack && data.projectStack.length > 0 && (
          <div>
            <h3 class="font-semibold mb-2">Technologies</h3>
            <div class="flex flex-wrap gap-2">
              {data.projectStack.map((tech: string) => (
                <span class="bg-gray-100 px-2 py-1 rounded text-sm">
                  {tech}
                </span>
              ))}
            </div>
          </div>
        )}

        {(data.projectLink || data.projectGit) && (
          <div>
            <h3 class="font-semibold mb-2">Liens</h3>
            <div class="space-y-2">
              {data.projectLink && (
                <a
                  href={data.projectLink}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="block text-accent-blue hover:underline"
                >
                  Voir le projet →
                </a>
              )}
              {data.projectGit && (
                <a
                  href={data.projectGit}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="block text-accent-blue hover:underline"
                >
                  Code source →
                </a>
              )}
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Back link -->
    <div class="mt-12 pt-8 border-t border-gray-200">
      <a href="/projets" class="text-accent-blue hover:underline">
        ← Retour aux projets
      </a>
    </div>
  </article>

  <Footer slot="footer" />
</Layout>
