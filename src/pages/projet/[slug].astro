---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const projects = await getCollection('projects', ({ data }) => !data.draft);

  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project }
  }));
}

const { project } = Astro.props;
const { data, body } = project;
const { Content } = await project.render();
const categories = await getEntry('data', 'categories');
const categoriesData = categories?.data || {};

function getCategoryColorClass(categoryName: string) {
  const category = categoriesData[categoryName];
  return category?.colorClass || 'beige';
}
---

<Layout title={data.title} description={data.projectResume}>
  <Header slot="header" />

  <article class="container mx-auto px-4 py-16 mt-16 max-w-4xl">
    <!-- Header -->
    <header class="mb-12">
      <h1 class="text-4xl md:text-5xl font-light mb-6">{data.title}</h1>

      {data.categories && data.categories.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-6">
          {data.categories.map((cat: string) => (
            <span class="badge" data-color={getCategoryColorClass(cat)}>
              {categoriesData[cat]?.name || cat}
            </span>
          ))}
        </div>
      )}

      {data.projectThumbnail && (
        <img
          src={data.projectThumbnail}
          alt={data.projectThumbnailAlt || data.title}
          class="w-full rounded-lg shadow-lg mb-8"
        />
      )}
    </header>

    <!-- Project Info -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
      <div class="md:col-span-2 space-y-8">
        <div>
          <h2 class="text-2xl mb-4">Résumé</h2>
          <p class="text-xl text-black">{data.projectResume}</p>
        </div>

        {body && (
          <div>
            <h2 class="text-2xl mb-4">Description</h2>
            <div class="prose prose-lg max-w-none">
              <Content />
            </div>
          </div>
        )}

        {data.testimony && (
          <div class="card p-6 flex-col rotate-left">
            <h3 class="text-xl font-semibold mb-2">Témoignage</h3>
            <p class="text-xl text-black">"{data.testimony}"</p>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        {data.clientName && (
          <div>
            <h3 class="text-xl font-semibold mb-2">Client</h3>
            <p class="text-black text-lg">{data.clientName}</p>
            {data.clientDescription && (
              <p class="text-base text-black mt-2">{data.clientDescription}</p>
            )}
          </div>
        )}

        {data.projectStatus && (
          <div>
            <h3 class="text-xl font-semibold mb-2">Statut</h3>
            <p class="text-black text-lg">{data.projectStatus}</p>
          </div>
        )}

        {data.projectDuration && (
          <div>
            <h3 class="text-xl font-semibold mb-2">Durée</h3>
            <p class="text-black text-lg">
              {data.projectDuration} {data.projectDurationUnit || ''}
            </p>
          </div>
        )}

        {data.projectStack && data.projectStack.length > 0 && (
          <div>
            <h3 class="text-xl font-semibold mb-2">Technologies</h3>
            <div class="flex flex-wrap gap-2">
              {data.projectStack.map((tech: string) => (
                <span class="badge">
                  {tech}
                </span>
              ))}
            </div>
          </div>
        )}

        {(data.projectLink || data.projectGit) && (
          <div>
            <h3 class="text-xl font-semibold mb-2">Liens</h3>
            <div class="space-y-2">
              {data.projectLink && (
                <a
                  href={data.projectLink}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="btn block text-center py-2"
                >
                  Voir le projet
                </a>
              )}
              {data.projectGit && (
                <a
                  href={data.projectGit}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="btn block text-center py-2"
                >
                  Code source
                </a>
              )}
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Back link -->
    <div class="mt-12 pt-8 ">
      <a href="/projets" class="btn inline-block py-3">
        ← Retour aux projets
      </a>
    </div>
  </article>

  <Footer slot="footer" />
</Layout>
