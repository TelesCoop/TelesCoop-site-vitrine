---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const articles = await getCollection('blog', ({ data }) => !data.draft);

  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article }
  }));
}

const { article } = Astro.props;
const { data, body } = article;
const { Content } = await article.render();
const categories = await getEntry('data', 'categories');
const categoriesData = categories?.data || {};

function getCategoryColor(categoryName: string) {
  const category = categoriesData[categoryName];
  const colorMap: Record<string, string> = {
    'grey': 'bg-gray-600',
    'orange': 'bg-accent-orange',
    'yellow': 'bg-accent-yellow',
    'danger': 'bg-red-600',
    'info': 'bg-blue-600',
    'success': 'bg-green-600',
    'blue': 'bg-accent-blue',
  };
  return colorMap[category?.colorClass] || 'bg-gray-600';
}

function getCategoryTextColor(categoryName: string) {
  const category = categoriesData[categoryName];
  return category?.textWhite ? 'text-white' : 'text-black';
}

const formattedDate = new Date(data.date).toLocaleDateString('fr-FR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Layout title={data.title} description={data.excerpt}>
  <Header slot="header" />

  <article class="container mx-auto px-4 py-16 mt-16 max-w-4xl">
    <!-- Header -->
    <header class="mb-12">
      <h1 class="text-4xl md:text-5xl font-light mb-6">{data.title}</h1>

      <div class="flex items-center gap-4 text-gray-600 mb-6">
        <time datetime={data.date.toISOString()}>{formattedDate}</time>
        <span>•</span>
        <span>{data.readTime} min de lecture</span>
      </div>

      {data.categories && data.categories.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-6">
          {data.categories.map((cat: string) => (
            <span
              class={`px-3 py-1 rounded-full text-sm font-medium ${getCategoryColor(cat)} ${getCategoryTextColor(cat)}`}
            >
              {categoriesData[cat]?.name || cat}
            </span>
          ))}
        </div>
      )}
    </header>

    <!-- Excerpt -->
    {data.excerpt && (
      <div class="bg-gray-50 border-l-4 border-accent-blue p-6 mb-8">
        <p class="text-lg text-gray-700 italic">{data.excerpt}</p>
      </div>
    )}

    <!-- Content -->
    <div class="prose prose-lg max-w-none mb-12">
      <Content />
    </div>

    <!-- Back link -->
    <div class="mt-12 pt-8 border-t border-gray-200">
      <a href="/blog" class="text-accent-blue hover:underline">
        ← Retour au blog
      </a>
    </div>
  </article>

  <Footer slot="footer" />
</Layout>

<style>
  /* Style for the content */
  .prose :global(h2) {
    @apply text-3xl font-semibold mt-8 mb-4;
  }

  .prose :global(h3) {
    @apply text-2xl font-semibold mt-6 mb-3;
  }

  .prose :global(p) {
    @apply mb-4 leading-relaxed text-gray-700;
  }

  .prose :global(ul), .prose :global(ol) {
    @apply mb-4 ml-6;
  }

  .prose :global(li) {
    @apply mb-2;
  }

  .prose :global(a) {
    @apply text-accent-blue hover:underline;
  }

  .prose :global(strong) {
    @apply font-semibold text-black;
  }

  .prose :global(em) {
    @apply italic;
  }

  .prose :global(blockquote) {
    @apply border-l-4 border-gray-300 pl-4 italic text-gray-700 my-6;
  }

  .prose :global(code) {
    @apply bg-gray-100 px-2 py-1 rounded text-sm font-mono;
  }

  .prose :global(pre) {
    @apply bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto my-6;
  }

  .prose :global(pre code) {
    @apply bg-transparent p-0;
  }
</style>
