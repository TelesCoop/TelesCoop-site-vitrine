---
interface Client {
  name: string;
  client: string;
  client_poste?: string;
  logo?: string;
  testimonial: string;
  borderColor: string;
}

interface Props {
  clients: Client[];
}

const { clients } = Astro.props;
---

<section class="px-4">
  <div class="container mx-auto">
    <div class="text-center mb-12">
      <span class="tag tag-purple tag-xl mb-6">Ce que nos clients disent de nous</span>
    </div>

    <div class="testimonials-wrapper">
      <div class="slider-container" id="testimonials-slider">
        {clients.map((client, index) => (
          <div class={`testimonial-card ${index % 2 === 0 ? 'rotate-left' : 'rotate-right'}`} data-index={index}>
            <div class="testimonial-number">
              {String(index + 1).padStart(2, '0')}
            </div>
            <div class="testimonial-content">
              {client.logo && (
                <img
                  src={client.logo}
                  alt={client.name}
                  class="h-8 md:h-12 object-contain self-start"
                  loading="lazy"
                  decoding="async"
                  onerror="this.style.display='none'"
                />
              )}
              <p class="font-medium text-base md:text-xl lg:text-2xl leading-relaxed">
                {client.testimonial}
              </p>
              <div class="mt-auto">
                <div class="flex items-center gap-4 mb-2">
                  <p class="font-semibold text-black text-lg md:text-xl lg:text-2xl">{client.client}{client.client_poste && `, ${client.client_poste}`}</p>

                </div>

                <p class="text-base md:text-lg mt-1 font-bold">{client.name}</p>
              </div>
            </div>
          </div>
        ))}
      </div>

      <div class="testimonials-nav">
        {clients.map((_, index) => (
          <button class="nav-dot" data-slide={index} aria-label={`Témoignage ${index + 1}`}>
            {String(index + 1).padStart(2, '0')}
          </button>
        ))}
      </div>
    </div>

    <div class="flex flex-col items-center gap-4 mt-12 text-center">
      <p class="text-lg md:text-xl lg:text-2xl">
        Votre projet vous paraît cohérent avec nos valeurs ?
        <strong class="font-bold">Écrivez-nous !</strong>
      </p>
      <a
        href="mailto:contact@telescoop.fr"
        class="btn btn-md md:btn-lg"
      >
        Contactez-nous
      </a>
    </div>
  </div>
</section>

<script>
  const cards = document.querySelectorAll('.testimonial-card');
  const navDots = document.querySelectorAll('.nav-dot');
  const slider = document.getElementById('testimonials-slider');
  let currentSlide = 0;
  let touchStartX = 0;
  let touchEndX = 0;

  function goToSlide(index: number) {
    if (index < 0) index = 0;
    if (index >= cards.length) index = cards.length - 1;

    currentSlide = index;

    cards.forEach((card, i) => {
      card.classList.remove('active', 'stack-1', 'stack-2');

      if (i === index) {
        card.classList.add('active');
      } else if (i === index + 1) {
        card.classList.add('stack-1');
      } else if (i === index + 2) {
        card.classList.add('stack-2');
      }
    });

    navDots.forEach((dot, i) => {
      if (i === index) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });
  }

  function handleSwipe() {
    const swipeDistance = touchEndX - touchStartX;
    const minSwipeDistance = 50;

    if (swipeDistance > minSwipeDistance) {
      // Swipe right - go to previous
      goToSlide(currentSlide - 1);
    } else if (swipeDistance < -minSwipeDistance) {
      // Swipe left - go to next
      goToSlide(currentSlide + 1);
    }
  }

  navDots.forEach((dot, index) => {
    dot.addEventListener('click', () => goToSlide(index));
  });

  // Touch events for swipe
  if (slider) {
    slider.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    slider.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    // Mouse events for desktop drag
    let mouseDown = false;
    let mouseStartX = 0;

    slider.addEventListener('mousedown', (e) => {
      mouseDown = true;
      mouseStartX = e.clientX;
    });

    slider.addEventListener('mouseup', (e) => {
      if (mouseDown) {
        const mouseEndX = e.clientX;
        const swipeDistance = mouseEndX - mouseStartX;
        const minSwipeDistance = 50;

        if (swipeDistance > minSwipeDistance) {
          goToSlide(currentSlide - 1);
        } else if (swipeDistance < -minSwipeDistance) {
          goToSlide(currentSlide + 1);
        }

        mouseDown = false;
      }
    });

    slider.addEventListener('mouseleave', () => {
      mouseDown = false;
    });
  }

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      goToSlide(currentSlide - 1);
    } else if (e.key === 'ArrowRight') {
      goToSlide(currentSlide + 1);
    }
  });

  // Initialize first slide
  goToSlide(0);
</script>
