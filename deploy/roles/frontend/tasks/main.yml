
- name: Check that the ssl exists.conf exists
  stat:
    path: /etc/letsencrypt/live/{{ url }}/fullchain.pem
  become: true
  register: ssl_exists

- name: Copy http nginx config
  template:
    src: nginx.http.conf.j2
    dest: /etc/nginx/sites-enabled/https-{{ url }}
    owner: root
    group: root
    mode: 0644
  become: true
  notify:
      - reload nginx
  when: not ssl_exists.stat.exists

- name: Create certificate
  command: 'certbot -n --nginx certonly -d {{ url }}'
  args:
    creates: '/etc/letsencrypt/live/{{ url }}'
  ignore_errors: false
  become: true
  tags:
    - nginx
    - certbot
  when: not ssl_exists.stat.exists

- name: Remove nginx config
  command: rm /etc/nginx/sites-enabled/https-{{ url }}
  become: true
  notify:
      - reload nginx
  when: not ssl_exists.stat.exists

- name: Copy {{ project_slug }} nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-enabled/{{ project_slug }}
    owner: root
    group: root
    mode: 0644
  notify:
    - reload nginx
    
- name: install node and npm
  apt:
    pkg:
      - nodejs
    state: present

- name: Create base dir
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ main_user }}"
    mode: '2755'
  with_items:
    - "{{ frontend_path }}"

- name: Generate frontend /etc/ssh/ RSA host key
  command: "ssh-keygen -q -t ed25519 -a 100 -f {{ identity_file_path }} -C \"\" -N \"\""
  become_user: "{{ main_user }}"
  args:
    creates: "{{ identity_file_path }}"
  register: frontend_new_ssh_key

- name: WARNING ABOUT new ssh key
  debug:
    msg: |
      IMPORTANT REMINDER

      A new ssh key has been generated at {{ identity_file_path }}
      - it should be added to the project deploy keys in Gitlab/Github
      so that we can clone it.
  when: frontend_new_ssh_key.changed

- name: Get new ssh key contents
  command: "cat {{ identity_file_path }}.pub"
  register: command_output
  when: frontend_new_ssh_key.changed

- name: Print ssh key to console
  debug:
    msg: "{{command_output.stdout}}"
  when: frontend_new_ssh_key.changed

- name: get latest frontend code
  git:
    repo: '{{ frontend_repo }}'
    dest: "{{ frontend_path }}"
    key_file: "{{ identity_file_path }}"
    accept_hostkey: true
    force: true
    version: "{{ frontend_branch }}"
  become_user: "{{ main_user }}"
  register: clonecode

- name: add environment variable file
  template:
    src: frontend.env
    dest: "{{ frontend_path }}/.env"

- name: Get node_version
  shell: "cat {{ frontend_path }}/.nvmrc"
  register: node_version

- name: Install nvm
  ansible.builtin.shell: >
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"

- name: "Install node version {{ node_version.stdout }}"
  shell: "source /root/.nvm/nvm.sh && nvm install {{ node_version.stdout }}"
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.nvm/{{ node_version.stdout }}_installed"

- name: Check if dist directory already exists
  stat:
    path: "{{ frontend_path }}/dist"
  register: dist_dir_before

- name: Install project node dependencies with npm
  shell: "source /root/.nvm/nvm.sh && nvm exec {{ node_version.stdout }} npm install"
  args:
    chdir: "{{ frontend_path }}"
    executable: /bin/bash
  when: clonecode.changed or force_update is defined or not dist_dir_before.stat.exists

- name: Build Astro site
  shell: "source /root/.nvm/nvm.sh && nvm exec {{ node_version.stdout }} npm run build"
  args:
    chdir: "{{ frontend_path }}"
    executable: /bin/bash
  when: clonecode.changed or force_update is defined or not dist_dir_before.stat.exists
  register: build_output

- name: Display build output if build ran
  debug:
    var: build_output.stdout_lines
  when: build_output is defined and build_output.changed

- name: Check if dist directory exists (Astro)
  stat:
    path: "{{ frontend_path }}/dist"
  register: dist_dir

- name: Check if _site directory exists (Eleventy legacy)
  stat:
    path: "{{ frontend_path }}/_site"
  register: site_dir

- name: Set build output directory
  set_fact:
    build_output_dir: "{{ 'dist' if dist_dir.stat.exists else '_site' if site_dir.stat.exists else 'none' }}"

- name: Display detected build output directory
  debug:
    msg: "Build output directory detected: {{ build_output_dir }}"

- name: Fail if no build output directory exists
  fail:
    msg: "Build failed - neither dist nor _site directory found at {{ frontend_path }}"
  when: build_output_dir == 'none'

- name: Make sure project files have the right owner after installs
  file:
    path: "{{ frontend_path }}"
    owner: "{{ main_user }}"
    group: "{{ main_user }}"
    recurse: true
    state: directory
  when: clonecode.changed or force_update is defined

- name: update frontend static folder
  file:
    path: "{{ frontend_static_path }}"
    state: "{{ item }}"
    owner: www-data
    mode: '2755'
  with_items:
    - absent
    - directory

- name: update frontend static folder content
  synchronize:
    src: "{{ frontend_path }}/{{ build_output_dir }}/"
    dest: "{{ frontend_static_path }}"
    rsync_opts:
      - "-og"
      - "--chown=www-data"

  delegate_to: "{{ inventory_hostname }}"
